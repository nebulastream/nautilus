name: NebulaStream Integration Test
run-name: Testing Nautilus with NebulaStream

on:
  pull_request:
    branches:
      - main
  workflow_dispatch:
    inputs:
      nebulastream_ref:
        description: 'NebulaStream branch/tag/commit to test against'
        required: false
        default: 'main'
        type: string

# Allow only one concurrent integration test
concurrency:
  group: nebulastream-integration-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test-nebulastream-integration:
    runs-on: ubuntu-24.04
    name: Test with NebulaStream ${{ inputs.nebulastream_ref || 'main' }}
    env:
      CC: clang-18
      CXX: clang++-18
      NEBULASTREAM_REF: ${{ inputs.nebulastream_ref || 'main' }}

    steps:
      - name: Check out Nautilus repository
        uses: actions/checkout@v4
        with:
          path: nautilus-current

      - name: Check out NebulaStream repository
        uses: actions/checkout@v4
        with:
          repository: nebulastream/nebulastream
          ref: ${{ env.NEBULASTREAM_REF }}
          path: nebulastream
          submodules: true

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            git \
            cmake \
            ninja-build \
            libssl-dev \
            libcurl4-openssl-dev \
            libboost-all-dev \
            default-jdk \
            jq

      - name: Replace Nautilus submodule with current version
        shell: bash
        run: |
          echo "Finding Nautilus submodule in NebulaStream..."
          cd nebulastream

          # Find the nautilus submodule path
          NAUTILUS_SUBMODULE=$(git config --file .gitmodules --get-regexp path | grep nautilus | awk '{print $2}' || echo "")

          if [ -z "$NAUTILUS_SUBMODULE" ]; then
            echo "::error::Could not find nautilus submodule in NebulaStream"
            echo "Searching for nautilus directory manually..."
            NAUTILUS_DIR=$(find . -type d -name "nautilus" -not -path "*/\.*" | head -1)
            if [ -n "$NAUTILUS_DIR" ]; then
              echo "Found nautilus directory at: $NAUTILUS_DIR"
              rm -rf "$NAUTILUS_DIR"
              cp -r ../nautilus-current "$NAUTILUS_DIR"
              echo "Replaced nautilus at $NAUTILUS_DIR with current version"
            else
              echo "::error::Could not find nautilus directory in NebulaStream"
              exit 1
            fi
          else
            echo "Found nautilus submodule at: $NAUTILUS_SUBMODULE"
            rm -rf "$NAUTILUS_SUBMODULE"
            cp -r ../nautilus-current "$NAUTILUS_SUBMODULE"
            echo "Replaced nautilus submodule with current version"
          fi

          # Remove nautilus from vcpkg.json if it exists to prevent vcpkg from trying to install it
          if [ -f "vcpkg.json" ]; then
            echo "Original vcpkg.json:"
            cat vcpkg.json
            echo ""
            echo "Removing nautilus from vcpkg.json..."
            # Use jq to filter out nautilus from dependencies
            # Handle both string dependencies ("nautilus") and object dependencies ({"name": "nautilus", ...})
            jq '.dependencies = [.dependencies[] | select(
              if type == "string" then . != "nautilus"
              elif type == "object" then .name != "nautilus"
              else true
              end
            )]' vcpkg.json > vcpkg.json.tmp
            mv vcpkg.json.tmp vcpkg.json
            echo ""
            echo "Updated vcpkg.json:"
            cat vcpkg.json
          fi

      - name: Get CMake
        uses: lukka/get-cmake@latest

      - name: Setup ccache
        uses: hendrikmuhs/ccache-action@v1.2.20
        with:
          key: nebulastream-integration-${{ env.NEBULASTREAM_REF }}-${{ github.sha }}
          restore-keys: |
            nebulastream-integration-${{ env.NEBULASTREAM_REF }}-
            nebulastream-integration-

      - name: Configure NebulaStream
        shell: bash
        working-directory: nebulastream
        run: |
          echo "Configuring NebulaStream with custom Nautilus..."
          cmake -DCMAKE_BUILD_TYPE=Release \
                -DCMAKE_C_COMPILER_LAUNCHER=ccache \
                -DCMAKE_CXX_COMPILER_LAUNCHER=ccache \
                -G Ninja -S . -B build

      - name: Build NebulaStream
        shell: bash
        working-directory: nebulastream
        run: |
          echo "Building NebulaStream..."
          cmake --build build --parallel $(nproc)

      - name: Run NebulaStream tests
        shell: bash
        working-directory: nebulastream
        run: |
          echo "Running NebulaStream tests..."
          ctest --test-dir build --output-on-failure --parallel $(nproc)

      - name: Integration test summary
        if: always()
        run: |
          echo "## NebulaStream Integration Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Nautilus commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **NebulaStream ref**: ${{ env.NEBULASTREAM_REF }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Test status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
